# 云函数配置说明

## 概述
本项目使用微信小程序云开发功能实现家族故事阅读器的点赞功能。用户可以通过选择身份（匿名或自定义昵称）为家族故事点赞，并查看最近的点赞记录。

## 配置步骤

### 1. 开通云开发
1. 在微信开发者工具中打开项目
2. 点击工具栏中的"云开发"按钮
3. 按照提示开通云开发服务
4. 创建云环境（建议创建两个环境：测试环境和生产环境）

### 2. 配置云环境ID
**重要：** 为了保护敏感信息，云环境ID现在通过配置文件管理，不会被提交到git。

1. 复制配置示例文件：
   ```bash
   cp miniprogram/config.example.js miniprogram/config.js
   ```

2. 编辑 `miniprogram/config.js`，填入你的云环境ID：
   ```javascript
   module.exports = {
     // 微信云开发环境ID
     cloudEnv: 'your-env-id-here', // 替换为你的实际云环境ID
   };
   ```

3. 云环境ID可以在微信开发者工具的云开发控制台中找到

**注意：** `miniprogram/config.js` 文件已被添加到 `.gitignore` 中，不会被提交到版本控制系统。

### 3. 部署云函数
1. 右键点击 `cloudfunctions/feedback` 文件夹
2. 选择"创建并部署：云端安装依赖（不上传 node_modules）"

### 4. 配置数据库
在云开发控制台中创建以下集合：

#### likes 集合（点赞记录）
- 权限设置：所有用户可读，仅创建者可写
- 字段说明：
  - `_id`：系统自动生成的唯一标识
  - `openid`：用户openid（字符串，必填）
  - `nickName`：用户昵称（字符串，支持自定义昵称或匿名用户）
  - `identityType`：身份类型（字符串，'anonymous' 或 'custom'）
  - `createTime`：创建时间（日期，必填）

### 5. 设置数据库索引（可选，用于优化性能）
1. 在 `likes` 集合中为 `createTime` 字段创建降序索引，提升查询性能

### 6. 测试功能
1. 在小程序中进入反馈页面
2. 点击爱心图标，测试身份选择弹窗
3. 测试匿名点赞功能
4. 测试自定义昵称点赞功能
5. 验证点赞记录显示（最近10条）
6. 测试点赞数量统计功能

## 云函数API说明

### feedback 云函数
支持以下操作：

#### 1. 获取点赞数量
```javascript
wx.cloud.callFunction({
  name: 'feedback',
  data: {
    action: 'getLikeCount'
  }
})
```

#### 2. 添加点赞
```javascript
wx.cloud.callFunction({
  name: 'feedback',
  data: {
    action: 'addLike',
    nickName: '用户昵称', // 可选，默认为'匿名用户'
    identityType: 'custom' // 'anonymous' 或 'custom'
  }
})
```

#### 3. 获取点赞记录
```javascript
wx.cloud.callFunction({
  name: 'feedback',
  data: {
    action: 'getLikes',
    page: 1, // 页码，默认1
    pageSize: 10 // 每页数量，默认10
  }
})
```

## 功能特性
- ✅ 点赞功能支持身份选择（匿名/自定义昵称）
- ✅ 实时显示点赞数量统计
- ✅ 显示最近10条点赞记录
- ✅ 紧凑的横排文字显示格式
- ✅ 优雅的身份选择弹窗界面
- ✅ 水墨风格的UI设计

## 注意事项
1. 云函数部署后需要等待几分钟才能生效
2. 确保小程序已开通云开发权限
3. 生产环境请妥善保管云环境ID
4. 建议定期备份数据库数据
5. 可以在云开发控制台中查看函数调用日志和数据库操作记录
6. 点赞记录按时间倒序排列，只显示最近10条记录

## 故障排除
1. 如果云函数调用失败，检查：
   - 云环境ID是否正确
   - 云函数是否部署成功
   - 网络连接是否正常
   - 查看云开发控制台的错误日志

2. 如果数据库操作失败，检查：
   - 集合权限设置是否正确
   - 数据格式是否符合要求
   - 用户是否有操作权限
   - `likes` 集合是否已创建

3. 如果点赞记录不显示，检查：
   - 数据库中是否有点赞数据
   - 云函数 `getLikes` 是否正常工作
   - 前端是否正确调用云函数

## 费用说明
- 云函数调用：按调用次数计费
- 数据库操作：按读写次数计费
- 存储空间：按使用容量计费
- 具体费用请参考微信云开发官方文档

## 更新日志
- v1.1.0: 去除留言功能，优化为纯点赞功能，支持身份选择
- v1.0.0: 基础版本，支持点赞和留言功能